name: Build and Push Container Images

on:
  push:
    branches: [main]
    paths:
      - 'docker/**'
      - 'sqlmesh/**'
      - 'cmd/podcast-scraper/**'
      - 'go.mod'
      - 'go.sum'
      - 'internal/**'
  workflow_dispatch:  # Allow manual trigger

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      postgres: ${{ steps.changes.outputs.postgres }}
      sqlmesh: ${{ steps.changes.outputs.sqlmesh }}
      scraper: ${{ steps.changes.outputs.scraper }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect changed files
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            postgres:
              - 'docker/postgres-duckdb/**'
            sqlmesh:
              - 'docker/sqlmesh/**'
              - 'sqlmesh/**'
            scraper:
              - 'cmd/podcast-scraper/**'
              - 'go.mod'
              - 'go.sum'
              - 'internal/**'

  build-postgres-duckdb:
    needs: detect-changes
    if: needs.detect-changes.outputs.postgres == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push postgres-duckdb
        uses: docker/build-push-action@v5
        with:
          context: ./docker/postgres-duckdb
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/postgres-duckdb:16
            ghcr.io/${{ github.repository_owner }}/postgres-duckdb:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-sqlmesh:
    needs: detect-changes
    if: needs.detect-changes.outputs.sqlmesh == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push eleduck-sqlmesh
        uses: docker/build-push-action@v5
        with:
          context: ./docker/sqlmesh
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/eleduck-sqlmesh:latest
            ghcr.io/${{ github.repository_owner }}/eleduck-sqlmesh:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-podcast-scraper:
    needs: detect-changes
    if: needs.detect-changes.outputs.scraper == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push podcast-scraper
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/podcast-scraper:latest
            ghcr.io/${{ github.repository_owner }}/podcast-scraper:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  trigger-deployment:
    needs: [build-postgres-duckdb, build-sqlmesh, build-podcast-scraper]
    if: |
      always() &&
      (needs.build-postgres-duckdb.result == 'success' ||
       needs.build-sqlmesh.result == 'success' ||
       needs.build-podcast-scraper.result == 'success')
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Trigger deployment workflow
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy.yaml',
              ref: 'main'
            })
            console.log('Deployment workflow triggered successfully')
